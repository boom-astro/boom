volumes:
  mongodb:
  valkey:
  kafka_data:

networks:
  boom:
  traefik-public:
    # Allow setting it to false for testing and local development
    external: true

services:
  mongo:
    image: mongo:8.0
    hostname: mongo
    expose:
      - "27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${BOOM_DATABASE__USERNAME:-mongoadmin}
      - MONGO_INITDB_ROOT_PASSWORD=${BOOM_DATABASE__PASSWORD:?BOOM_DATABASE__PASSWORD must be set and non-empty}
    volumes:
      - mongodb:/data/db
    restart: always
    networks:
      - boom
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      start_period: 20s
  valkey:
    image: valkey/valkey:7.2.6
    environment:
      # ALLOW_EMPTY_PASSWORD is recommended only for development.
      - ALLOW_EMPTY_PASSWORD=yes
      - VALKEY_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    volumes:
      - valkey:/data
    restart: always
    networks:
      - boom
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
  broker:
    image: apache/kafka:latest
    hostname: broker
    networks:
      - boom
      - traefik-public
    restart: always
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,EXTERNAL:SASL_PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092,EXTERNAL://${KAFKA_EXTERNAL_HOST:-localhost}:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@broker:29093
      KAFKA_LISTENERS: PLAINTEXT://broker:29092,CONTROLLER://broker:29093,PLAINTEXT_HOST://0.0.0.0:9092,EXTERNAL://0.0.0.0:9093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      KAFKA_NUM_PARTITIONS: 15
      KAFKA_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_LISTENER_NAME_EXTERNAL_SASL_ENABLED_MECHANISMS: SCRAM-SHA-512
      KAFKA_AUTHORIZER_CLASS_NAME: org.apache.kafka.metadata.authorizer.StandardAuthorizer
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: 'true'
      # Include ANONYMOUS because inter-broker + controller channels use PLAINTEXT (no SASL),
      # so the principal resolves to User:ANONYMOUS. Without granting it super-user rights,
      # controller metadata or internal admin ops can be unauthorized and cause the process to exit.
      # (Alternative: secure internal listener with SASL and drop ANONYMOUS.)
      KAFKA_SUPER_USERS: "User:admin;User:ANONYMOUS"
      KAFKA_OPTS: -Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf
    volumes:
      - kafka_data:/var/lib/kafka/data
      - ./config/kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf:ro
    healthcheck:
      # Robust readiness: ensure controller quorum responds and broker APIs are available, with explicit timeouts
      test: ["CMD-SHELL", "set -euo pipefail; \
        timeout 8s /opt/kafka/bin/kafka-metadata-quorum.sh --bootstrap-server broker:29092 describe --status >/dev/null 2>&1 && \
        timeout 6s /opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server broker:29092 >/dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 6
      start_period: 30s
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.constraint-label=traefik-public
      - traefik.tcp.services.${STACK_NAME?Variable not set}-kafka.loadbalancer.server.port=9093
      - traefik.tcp.routers.${STACK_NAME?Variable not set}-kafka.rule=HostSNI(`*`)
      - traefik.tcp.routers.${STACK_NAME?Variable not set}-kafka.entrypoints=kafka
      # Uncomment to enable TLS passthrough (requires EXTERNAL listener to use SSL)
      # - traefik.tcp.routers.${STACK_NAME?Variable not set}-kafka.tls.passthrough=true
  kafka-acl-init:
    image: apache/kafka:latest
    hostname: kafka-acl-init
    depends_on:
      broker:
        condition: service_healthy
    networks:
      - boom
    environment:
      KAFKA_ADMIN_PASSWORD: ${KAFKA_ADMIN_PASSWORD:?Set KAFKA_ADMIN_PASSWORD}
      KAFKA_READONLY_PASSWORD: ${KAFKA_READONLY_PASSWORD:?Set KAFKA_READONLY_PASSWORD}
    volumes:
      - ./scripts/init_kafka_acls.sh:/init_kafka_acls.sh:ro
    entrypoint: ["bash","/init_kafka_acls.sh"]
    restart: "no"
  api:
    image: boom-astro/boom:latest
    hostname: api
    build:
      context: .
      dockerfile: Dockerfile
    command:
      - /app/boom-api
    environment:
      # Required secrets - must be set in environment
      BOOM_DATABASE__PASSWORD: ${BOOM_DATABASE__PASSWORD:?BOOM_DATABASE__PASSWORD must be set}
      BOOM_API__AUTH__SECRET_KEY: ${BOOM_API__AUTH__SECRET_KEY:?BOOM_API__AUTH__SECRET_KEY must be set}
      BOOM_API__AUTH__ADMIN_PASSWORD: ${BOOM_API__AUTH__ADMIN_PASSWORD:?BOOM_API__AUTH__ADMIN_PASSWORD must be set}
      # Optional overrides (these have defaults in config.yaml)
      BOOM_DATABASE__HOST: mongo
      BOOM_DATABASE__USERNAME: ${BOOM_DATABASE__USERNAME:-mongoadmin}
      BOOM_BABAMUL__ENABLED: ${BOOM_BABAMUL__ENABLED:-false}
    networks:
      - boom
      - traefik-public
    volumes:
      - ${PWD}/config.yaml:/app/config.yaml
    profiles:
      - prod
      - api
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.constraint-label=traefik-public
      - traefik.http.services.${STACK_NAME?Variable not set}-api.loadbalancer.server.port=4000
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-http.rule=Host(`api.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-http.entrypoints=http
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-https.rule=Host(`api.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-https.entrypoints=https
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-https.tls=true
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-https.tls.certresolver=le
      # Define Traefik Middleware to handle domain with and without "www" to redirect to only one
      - traefik.http.middlewares.${STACK_NAME?Variable not set}-www-redirect.redirectregex.regex=^http(s)?://www.(${DOMAIN?Variable not set})/(.*)
      # Redirect a domain with www to non-www
      - traefik.http.middlewares.${STACK_NAME?Variable not set}-www-redirect.redirectregex.replacement=http$${1}://${DOMAIN?Variable not set}/$${3}
      # Enable www redirection for HTTP and HTTPS
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-http.middlewares=https-redirect,${STACK_NAME?Variable not set}-www-redirect
      - traefik.http.routers.${STACK_NAME?Variable not set}-api-https.middlewares=${STACK_NAME?Variable not set}-www-redirect
  consumer-ztf:
    image: boom-astro/boom:latest
    hostname: consumer-ztf
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Required secrets - must be set in environment
      BOOM_DATABASE__PASSWORD: ${BOOM_DATABASE__PASSWORD:?BOOM_DATABASE__PASSWORD must be set}
      # Optional overrides
      BOOM_DATABASE__HOST: mongo
      BOOM_DATABASE__USERNAME: ${BOOM_DATABASE__USERNAME:-mongoadmin}
    networks:
      - boom
    profiles:
      - prod
    volumes:
      - ${PWD}/config.yaml:/app/config.yaml
    command:
      - /app/kafka_consumer
      - ztf
      - --auto-switch-date
  consumer-lsst:
    image: boom-astro/boom:latest
    hostname: consumer-lsst
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Required secrets - must be set in environment
      BOOM_DATABASE__PASSWORD: ${BOOM_DATABASE__PASSWORD:?BOOM_DATABASE__PASSWORD must be set}
      # Optional overrides
      BOOM_DATABASE__HOST: mongo
      BOOM_DATABASE__USERNAME: ${BOOM_DATABASE__USERNAME:-mongoadmin}
    networks:
      - boom
    profiles:
      - prod
    volumes:
      - ${PWD}/config.yaml:/app/config.yaml
    command:
      - /app/kafka_consumer
      - lsst
  scheduler-ztf:
    image: boom-astro/boom:latest
    hostname: scheduler-ztf
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Required secrets - must be set in environment
      BOOM_DATABASE__PASSWORD: ${BOOM_DATABASE__PASSWORD:?BOOM_DATABASE__PASSWORD must be set}
      # Optional overrides
      BOOM_DATABASE__HOST: mongo
      BOOM_DATABASE__USERNAME: ${BOOM_DATABASE__USERNAME:-mongoadmin}
      BOOM_BABAMUL__ENABLED: ${BOOM_BABAMUL__ENABLED:-false}
    networks:
      - boom
    profiles:
      - prod
    volumes:
      - ${PWD}/config.yaml:/app/config.yaml
      - ${PWD}/data/models:/app/data/models
    command:
      - /app/scheduler
      - ztf
  scheduler-lsst:
    image: boom-astro/boom:latest
    hostname: scheduler-lsst
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Required secrets - must be set in environment
      BOOM_DATABASE__PASSWORD: ${BOOM_DATABASE__PASSWORD:?BOOM_DATABASE__PASSWORD must be set}
      # Optional overrides
      BOOM_DATABASE__HOST: mongo
      BOOM_DATABASE__USERNAME: ${BOOM_DATABASE__USERNAME:-mongoadmin}
      BOOM_BABAMUL__ENABLED: ${BOOM_BABAMUL__ENABLED:-false}
    networks:
      - boom
    profiles:
      - prod
    volumes:
      - ${PWD}/config.yaml:/app/config.yaml
      - ${PWD}/data/models:/app/data/models
    command:
      - /app/scheduler
      - lsst
  otel-collector: # [^1]
    image: otel/opentelemetry-collector:0.131.1
    volumes:
      - ./config/otel-collector-config.yaml:/etc/otelcol/config.yaml
    networks:
      - boom
  prometheus:
    image: prom/prometheus:latest
    command:
      - --web.enable-otlp-receiver # [^2]
      - --config.file=/etc/prometheus/prometheus.yaml
    volumes:
      - ./config/prometheus.yaml:/etc/prometheus/prometheus.yaml
    expose:
      - "9090"
    networks:
      - boom
      - traefik-public
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.constraint-label=traefik-public
      - traefik.http.services.${STACK_NAME?Variable not set}-prometheus.loadbalancer.server.port=9090
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-http.rule=Host(`prometheus.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-http.entrypoints=http
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-https.rule=Host(`prometheus.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-https.entrypoints=https
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-https.tls=true
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-https.tls.certresolver=le
      # HTTPS redirect middleware
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-http.middlewares=https-redirect
      # Basic auth middleware
      - traefik.http.middlewares.${STACK_NAME?Variable not set}-prometheus-auth.basicauth.users=${PROMETHEUS_USER:?PROMETHEUS_USER must be set}:${PROMETHEUS_HASHED_PASSWORD:?PROMETHEUS_HASHED_PASSWORD must be set}
      - traefik.http.routers.${STACK_NAME?Variable not set}-prometheus-https.middlewares=${STACK_NAME?Variable not set}-prometheus-auth
    restart: always

# [^1]:
#   * https://opentelemetry.io/docs/collector/quick-start/
#   * https://opentelemetry.io/docs/collector/installation/#docker-compose

# [^2]: https://prometheus.io/docs/guides/opentelemetry/#enable-the-otlp-receiver
