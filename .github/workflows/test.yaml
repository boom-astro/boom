name: Unit Tests

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions: write-all
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true
        clean: false
        lfs: 'true'
    - name: Setup System Dependencies
      run: sudo apt-get install -y libsasl2-dev
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
    - name: Configure cache
      uses: Swatinem/rust-cache@v2
    - name: Create default .env file & enable Babamul
      run: |
        cp .env.example .env
        sed -i 's/BOOM_BABAMUL__ENABLED=false/BOOM_BABAMUL__ENABLED=true/' .env
    - name: Install Kafka CLI tools
      run: |
        KAFKA_VERSION=4.1.1
        SCALA_VERSION=2.13
        sudo apt-get update && sudo apt-get install -y --no-install-recommends \
            libsasl2-2 ca-certificates openjdk-25-jre-headless curl bash tar
        sudo curl -fsSL https://dlcdn.apache.org/kafka/${KAFKA_VERSION}/kafka_${SCALA_VERSION}-${KAFKA_VERSION}.tgz -o /tmp/kafka.tgz
        sudo tar -xzf /tmp/kafka.tgz -C /opt
        sudo ln -s /opt/kafka_${SCALA_VERSION}-${KAFKA_VERSION} /opt/kafka
        sudo rm -f /tmp/kafka.tgz
    - name: Start services
      run: docker compose up --build -d
    - name: Wait for MongoDB to be ready
      run: |
        echo "Waiting for MongoDB to be ready..."
        for i in {1..60}; do
          if docker compose exec -T mongo mongosh localhost:27017/test --quiet --eval "db.runCommand('ping').ok" >/dev/null 2>&1; then
            echo "MongoDB is ready!"
            break
          fi
          echo "Attempt $i/60 - MongoDB not ready yet, waiting..."
          sleep 2
        done
        # Final check to confirm MongoDB is ready
        if ! docker compose exec -T mongo mongosh localhost:27017/test --quiet --eval "db.runCommand('ping').ok" >/dev/null 2>&1; then
          echo "MongoDB failed to start within timeout" >&2
          docker compose logs mongo || true
          exit 1
        fi
        docker compose exec -T mongo mongosh localhost:27017/boom_test --quiet --username mongoadmin --password mongoadminsecret --authenticationDatabase admin --eval "db.createCollection('LSPSC'); db.LSPSC.createIndex({'coordinates.radec_geojson': '2dsphere'});"
    - name: Wait for Kafka ACL initialization
      run: |
        echo "Waiting for kafka-acl-init container to start..."
        for i in {1..60}; do
          if docker compose ps --status running kafka-acl-init >/dev/null 2>&1 || docker compose ps kafka-acl-init 2>&1 | grep -q kafka-acl-init; then
            break
          fi
          sleep 2
        done
        CID=$(docker compose ps -q kafka-acl-init)
        if [ -z "$CID" ]; then
          echo "kafka-acl-init container not found" >&2
          exit 1
        fi
        echo "Container ID: $CID. Waiting for it to exit..."
        EXIT_CODE=$(docker wait "$CID")
        echo "kafka-acl-init exited with code $EXIT_CODE"
        if [ "$EXIT_CODE" != "0" ]; then
          echo "--- kafka-acl-init logs: ---"
          docker compose logs kafka-acl-init || true
          echo "--- broker logs: ---"
          docker compose logs broker || true
          exit 1
        fi
        echo "kafka-acl-init completed successfully."
    - name: Test BOOM
      run: PATH=/opt/kafka/bin:$PATH cargo test --release
