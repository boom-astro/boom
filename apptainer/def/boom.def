Bootstrap: docker
From: rust:1.91.1-slim-trixie

%environment
    export PATH=/app:/opt/kafka/bin:$PATH
    # Optional overrides
    export BOOM_DATABASE__HOST=localhost

%files
    Cargo.toml /app/Cargo.toml
    Cargo.lock /app/Cargo.lock
    apache-avro-macros /app/apache-avro-macros
    data/models /app/data/models
    data/ls_footprint_moc.fits /app/data/ls_footprint_moc.fits
    src /app/src

%post
    KAFKA_VERSION=4.1.1
    SCALA_VERSION=2.13
    apt-get update && \
    apt-get install -y --no-install-recommends \
      curl gcc g++ libhdf5-dev perl \
      make libsasl2-dev pkg-config \
      libsasl2-2 ca-certificates \
      openjdk-25-jre-headless tar && \
    apt-get autoremove && apt-get clean && rm -rf /var/lib/apt/lists/*

    # Install Kafka CLI tools
    curl -fsSL https://dlcdn.apache.org/kafka/${KAFKA_VERSION}/kafka_${SCALA_VERSION}-${KAFKA_VERSION}.tgz -o /tmp/kafka.tgz && \
    tar -xzf /tmp/kafka.tgz -C /opt && \
    ln -s /opt/kafka_${SCALA_VERSION}-${KAFKA_VERSION} /opt/kafka && \
    rm -f /tmp/kafka.tgz

    cd /app || exit 1
    cargo build --release

    cp /app/target/release/kafka_producer /app/kafka_producer
    cp /app/target/release/kafka_consumer /app/kafka_consumer
    cp /app/target/release/scheduler /app/scheduler
    cp /app/target/release/api /app/boom-api